<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Change Password</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link rel="icon" href="/static/assets/favicon.png" />
</head>

<body data-requires-auth="true">

  <div class="top-bar">
    <a href="/" class="logo-link" aria-label="Home">
      <img src="/static/img/logo.png" alt="Flosendo" class="logo" />
    </a>

    <div class="top-bar-right">
      <a class="btn" href="/student" id="backBtn">Back</a>
      <button id="logoutBtn" type="button" class="btn">Logout</button>
    </div>
  </div>

  <div class="page">
    <div class="card" style="max-width: 520px; margin: 0 auto;">
      <div class="card-header">Change your password</div>
      <p class="text-muted text-small">Use a strong password (8+ characters).</p>

      <label class="text-small">Current password</label>
      <input id="currentPw" type="password" autocomplete="current-password" />

      <div class="mt-12"></div>

      <label class="text-small">New password</label>
      <input id="newPw" type="password" autocomplete="new-password" />

      <div class="mt-12"></div>

      <label class="text-small">Confirm new password</label>
      <input id="newPw2" type="password" autocomplete="new-password" />

      <div class="mt-12"></div>

      <button id="savePwBtn" type="button" class="btn-primary" style="width:100%;">Update password</button>
      <p id="pwMsg" class="text-muted text-small mt-8"></p>
    </div>
  </div>

  <script src="/static/js/dashboard.js"></script>
  <script>
    const currentPw = document.getElementById("currentPw");
    const newPw = document.getElementById("newPw");
    const newPw2 = document.getElementById("newPw2");
    const savePwBtn = document.getElementById("savePwBtn");
    const pwMsg = document.getElementById("pwMsg");

    async function setBackLinkByRole(){
      try{
        const res = await fetch("/auth/me");
        if(!res.ok) return;
        const me = await res.json();
        const backBtn = document.getElementById("backBtn");
        if(me.role === "teacher") backBtn.href = "/teacher";
        else if(me.role === "admin") backBtn.href = "/admin";
        else backBtn.href = "/student";
      }catch(e){}
    }

    savePwBtn.addEventListener("click", async () => {
      pwMsg.textContent = "";
      const cur = currentPw.value || "";
      const np = newPw.value || "";
      const np2 = newPw2.value || "";

      if (np !== np2) {
        pwMsg.textContent = "New passwords do not match.";
        return;
      }

      savePwBtn.disabled = true;
      pwMsg.textContent = "Updating...";

      try {
        const res = await fetch("/auth/change-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ current_password: cur, new_password: np })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || "Failed to update password");

        pwMsg.textContent = "Password updated successfully ";
        currentPw.value = "";
        newPw.value = "";
        newPw2.value = "";
      } catch (e) {
        pwMsg.textContent = e.message || "Error";
      } finally {
        savePwBtn.disabled = false;
      }
    });

    setBackLinkByRole();
  </script>
</body>
</html>
